<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Debug - StriveTrack</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100 min-h-screen p-8">
    <div class="max-w-4xl mx-auto bg-white rounded-lg shadow p-6">
        <h1 class="text-2xl font-bold mb-6">StriveTrack Upload Debug Tool</h1>
        
        <div id="auth-section" class="mb-6">
            <h2 class="text-xl font-semibold mb-4">Authentication</h2>
            <div id="auth-status" class="mb-4 p-4 bg-gray-50 rounded">
                Checking authentication...
            </div>
            <div class="flex gap-4 mb-2">
                <input type="email" id="email" placeholder="Email" class="px-3 py-2 border rounded">
                <input type="password" id="password" placeholder="Password" class="px-3 py-2 border rounded">
                <button onclick="signIn()" class="px-4 py-2 bg-blue-500 text-white rounded">Sign In</button>
                <button onclick="signOut()" class="px-4 py-2 bg-red-500 text-white rounded">Sign Out</button>
            </div>
            <div class="flex gap-4">
                <button onclick="createTestAccount()" class="px-4 py-2 bg-green-500 text-white rounded">Create Test Account</button>
                <button onclick="useTestCredentials()" class="px-4 py-2 bg-purple-500 text-white rounded">Use Test Credentials</button>
            </div>
        </div>
        
        <div id="upload-section" class="mb-6">
            <h2 class="text-xl font-semibold mb-4">Upload Test</h2>
            <div class="flex gap-4 mb-4">
                <input type="file" id="fileInput" accept="image/*,video/*" class="block">
                <button onclick="testUpload()" class="px-4 py-2 bg-green-500 text-white rounded">Test Upload</button>
            </div>
            <div id="upload-status" class="p-4 bg-gray-50 rounded">
                Ready for upload test...
            </div>
        </div>
        
        <div id="logs" class="border p-4 bg-black text-green-400 font-mono text-sm max-h-96 overflow-y-auto">
            <div>Debug logs will appear here...</div>
        </div>
    </div>

    <script>
        // Initialize Supabase
        const supabaseUrl = 'https://zomwnkyxixidyfftdabj.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpvbXdua3l4aXhpZHlmZnRkYWJqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjcxMzk5OTQsImV4cCI6MjA0MjcxNTk5NH0.FdJ_Xus7iCJ6xlWINDsF7SAjEWH1dYWh4OKjfq8P7bk'
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey)
        
        const API_BASE = 'https://strivetrack-media-api.iamhollywoodpro.workers.dev/api';
        
        function log(message) {
            const logs = document.getElementById('logs');
            const time = new Date().toLocaleTimeString();
            logs.innerHTML += `<div>[${time}] ${message}</div>`;
            logs.scrollTop = logs.scrollHeight;
            console.log(message);
        }
        
        async function checkAuth() {
            try {
                const { data: sessionData, error } = await supabaseClient.auth.getSession();
                const user = sessionData?.session?.user;
                const token = sessionData?.session?.access_token;
                
                const authStatus = document.getElementById('auth-status');
                
                if (user) {
                    authStatus.innerHTML = `
                        <div class="text-green-600">
                            ✅ Authenticated as: ${user.email}<br>
                            🆔 User ID: ${user.id}<br>
                            🔑 Token: ${token ? 'Present' : 'Missing'} (${token ? token.substring(0, 20) + '...' : 'None'})<br>
                            📅 Session expires: ${sessionData?.session?.expires_at ? new Date(sessionData.session.expires_at * 1000).toLocaleString() : 'Unknown'}
                        </div>
                    `;
                    log(`✅ User authenticated: ${user.email} (ID: ${user.id})`);
                    log(`🔑 Token: ${token ? 'Valid' : 'Missing'}`);
                } else {
                    authStatus.innerHTML = '<div class="text-red-600">❌ Not authenticated</div>';
                    log('❌ No user session found');
                }
            } catch (error) {
                log(`💥 Auth check error: ${error.message}`);
            }
        }
        
        async function signIn() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                log('⚠️ Please enter email and password');
                return;
            }
            
            log(`🔐 Attempting sign in for: ${email}`);
            
            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email,
                    password
                });
                
                if (error) {
                    log(`❌ Sign in failed: ${error.message}`);
                } else {
                    log(`✅ Sign in successful for: ${data.user.email}`);
                    setTimeout(checkAuth, 1000); // Check auth after slight delay
                }
            } catch (error) {
                log(`💥 Sign in error: ${error.message}`);
            }
        }
        
        async function signOut() {
            log('🚪 Signing out...');
            try {
                const { error } = await supabaseClient.auth.signOut();
                if (error) {
                    log(`❌ Sign out failed: ${error.message}`);
                } else {
                    log('✅ Sign out successful');
                    setTimeout(checkAuth, 1000);
                }
            } catch (error) {
                log(`💥 Sign out error: ${error.message}`);
            }
        }
        
        async function createTestAccount() {
            const testEmail = `test-${Date.now()}@strivetrack.local`;
            const testPassword = 'TestPass123!';
            
            log(`🧪 Creating test account: ${testEmail}`);
            
            try {
                const { data, error } = await supabaseClient.auth.signUp({
                    email: testEmail,
                    password: testPassword
                });
                
                if (error) {
                    log(`❌ Account creation failed: ${error.message}`);
                } else {
                    log(`✅ Account created successfully: ${testEmail}`);
                    log(`🔑 Password: ${testPassword}`);
                    log(`📧 Check if email confirmation is required or auto sign-in worked`);
                    
                    // Update form fields
                    document.getElementById('email').value = testEmail;
                    document.getElementById('password').value = testPassword;
                    
                    setTimeout(checkAuth, 2000);
                }
            } catch (error) {
                log(`💥 Account creation error: ${error.message}`);
            }
        }
        
        function useTestCredentials() {
            // Use predetermined test credentials
            const testEmail = 'test@strivetrack.local';
            const testPassword = 'TestPass123!';
            
            document.getElementById('email').value = testEmail;
            document.getElementById('password').value = testPassword;
            
            log(`🔧 Test credentials loaded: ${testEmail} / ${testPassword}`);
        }
        
        async function testUpload() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                log('⚠️ Please select a file first');
                return;
            }
            
            log(`📂 Selected file: ${file.name} (${file.type}, ${(file.size / 1024 / 1024).toFixed(2)} MB)`);
            
            try {
                // Check auth first
                const { data: sessionData } = await supabaseClient.auth.getSession();
                const token = sessionData?.session?.access_token;
                const userId = sessionData?.session?.user?.id;
                
                if (!token || !userId) {
                    log('❌ Not authenticated - please sign in first');
                    return;
                }
                
                log(`🔑 Using token: ${token.substring(0, 30)}...`);
                log(`👤 User ID: ${userId}`);
                
                // Test token validity directly with Supabase
                log(`🔍 Testing token validity with Supabase...`);
                try {
                    const supabaseTestResponse = await fetch(`${supabaseUrl}/auth/v1/user`, {
                        headers: { 
                            'Authorization': `Bearer ${token}`,
                            'apikey': supabaseKey
                        }
                    });
                    log(`🔍 Supabase token test: ${supabaseTestResponse.status} ${supabaseTestResponse.statusText}`);
                    if (supabaseTestResponse.ok) {
                        const supabaseUser = await supabaseTestResponse.json();
                        log(`✅ Supabase user: ${supabaseUser.email} (ID: ${supabaseUser.id})`);
                    } else {
                        const errorText = await supabaseTestResponse.text();
                        log(`❌ Supabase token validation failed: ${errorText}`);
                        
                        // If Supabase token validation fails, the upload will definitely fail
                        log(`🚫 Skipping upload test - invalid authentication`);
                        uploadStatus.innerHTML = '<div class="text-red-600">❌ Authentication invalid - upload would fail</div>';
                        return;
                    }
                } catch (supabaseError) {
                    log(`💥 Supabase token test error: ${supabaseError.message}`);
                    log(`🚫 Skipping upload test - token validation failed`);
                    uploadStatus.innerHTML = `<div class="text-red-600">💥 Token validation error: ${supabaseError.message}</div>`;
                    return;
                }
                
                const uploadStatus = document.getElementById('upload-status');
                uploadStatus.innerHTML = '<div class="text-blue-600">🚀 Starting upload...</div>';
                
                // Test the upload endpoint
                log(`📤 Uploading to: ${API_BASE}/upload`);
                log(`🔍 Headers: Authorization: Bearer ${token.substring(0, 20)}...`);
                log(`🔍 Headers: x-file-name: ${file.name}`);
                log(`🔍 Headers: Content-Type: ${file.type}`);
                log(`🔍 Headers: Content-Length: ${file.size}`);
                
                const response = await fetch(`${API_BASE}/upload`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'x-file-name': file.name,
                        'Content-Type': file.type,
                        'Content-Length': file.size.toString()
                    },
                    body: file
                });
                
                log(`📥 Response status: ${response.status} ${response.statusText}`);
                log(`📋 Response headers: ${JSON.stringify(Object.fromEntries(response.headers))}`);
                
                if (response.ok) {
                    const result = await response.json();
                    log(`✅ Upload successful! Result: ${JSON.stringify(result)}`);
                    uploadStatus.innerHTML = '<div class="text-green-600">✅ Upload successful!</div>';
                    
                    // Test verification
                    log(`🔍 Verifying upload at: ${API_BASE}/media/${encodeURIComponent(result.key)}`);
                    const verifyResponse = await fetch(`${API_BASE}/media/${encodeURIComponent(result.key)}`, {
                        method: 'HEAD',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    log(`✓ Verification result: ${verifyResponse.status} ${verifyResponse.statusText}`);
                    
                    if (verifyResponse.ok) {
                        log(`🎉 COMPLETE SUCCESS! Upload and verification both passed!`);
                        uploadStatus.innerHTML = '<div class="text-green-600">🎉 COMPLETE SUCCESS! Upload working perfectly!</div>';
                    } else {
                        log(`⚠️ Upload succeeded but verification failed - this might be a permissions issue`);
                        uploadStatus.innerHTML = '<div class="text-yellow-600">⚠️ Upload succeeded but verification failed</div>';
                    }
                    
                } else {
                    const errorText = await response.text();
                    log(`❌ Upload failed: ${errorText}`);
                    uploadStatus.innerHTML = `<div class="text-red-600">❌ Upload failed: ${errorText}</div>`;
                }
                
            } catch (error) {
                log(`💥 Upload error: ${error.message}`);
                uploadStatus.innerHTML = `<div class="text-red-600">💥 Error: ${error.message}</div>`;
            }
        }
        
        // Initialize
        window.addEventListener('load', () => {
            log('🚀 Debug tool loaded');
            checkAuth();
            
            // Listen for auth changes
            supabaseClient.auth.onAuthStateChange((event, session) => {
                log(`🔄 Auth state changed: ${event}`);
                setTimeout(checkAuth, 500);
            });
        });
    </script>
</body>
</html>