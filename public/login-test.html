<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login & Community Hub Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100 min-h-screen p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-blue-600 mb-8">üîê Authentication & Community Hub Test</h1>
        
        <!-- Login Section -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-bold mb-4">Step 1: Test Login</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Email</label>
                    <input type="email" id="email" value="iamhollywoodpro@gmail.com" class="w-full border rounded px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Password</label>
                    <input type="password" id="password" class="w-full border rounded px-3 py-2">
                </div>
                <button onclick="testLogin()" class="bg-blue-500 text-white px-6 py-2 rounded hover:bg-blue-600">
                    Test Login
                </button>
            </div>
            <div id="login-results" class="mt-4 p-3 bg-gray-50 rounded text-sm"></div>
        </div>

        <!-- API Test Section -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-bold mb-4">Step 2: Test Social API with Auth</h2>
            <div class="space-y-3">
                <button onclick="testPosts()" class="bg-green-500 text-white px-4 py-2 rounded mr-2">
                    Test Posts API
                </button>
                <button onclick="testFriends()" class="bg-purple-500 text-white px-4 py-2 rounded mr-2">
                    Test Friends API
                </button>
                <button onclick="testLeaderboard()" class="bg-red-500 text-white px-4 py-2 rounded">
                    Test Leaderboard API
                </button>
            </div>
            <div id="api-results" class="mt-4 p-3 bg-gray-50 rounded text-sm max-h-96 overflow-y-auto"></div>
        </div>

        <!-- Community Hub Link -->
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-bold mb-4">Step 3: Access Community Hub</h2>
            <p class="text-gray-600 mb-4">After successful login, test the actual Community Hub:</p>
            <a href="/community-hub" target="_blank" class="bg-blue-600 text-white px-6 py-3 rounded-lg inline-block hover:bg-blue-700">
                Open Community Hub
            </a>
        </div>
    </div>

    <script>
        // Initialize Supabase (using the correct config from your app)
        const supabaseUrl = 'https://rftjybtdvfffzqgotdly.supabase.co'
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJmdGp5YnRkdmZmZnpxZ290ZGx5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMTQ0MTMsImV4cCI6MjA3Mzc5MDQxM30.x1jA2cWY8w_twtJ7-JaFvhAFvwrVtTGpQSsqaBBJx6c'
        
        const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey)
        
        const API_URL = 'https://3002-i8diwm964nb6ljbdespoj-6532622b.e2b.dev'
        let currentSession = null

        function log(elementId, message, isError = false) {
            const element = document.getElementById(elementId)
            const timestamp = new Date().toLocaleTimeString()
            const style = isError ? 'color: red;' : 'color: green;'
            element.innerHTML += `<div style="${style}">[${timestamp}] ${message}</div>`
            element.scrollTop = element.scrollHeight
        }

        async function testLogin() {
            const email = document.getElementById('email').value
            const password = document.getElementById('password').value
            
            log('login-results', 'Testing login...', false)
            
            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                })

                if (error) {
                    log('login-results', `‚ùå Login failed: ${error.message}`, true)
                } else {
                    currentSession = data.session
                    log('login-results', `‚úÖ Login successful!`, false)
                    log('login-results', `User ID: ${data.user.id}`, false)
                    log('login-results', `Email: ${data.user.email}`, false)
                    log('login-results', `Access Token: ${data.session.access_token.substring(0, 20)}...`, false)
                    log('login-results', 'üöÄ Ready to test Social API!', false)
                }
            } catch (error) {
                log('login-results', `‚ùå Login error: ${error.message}`, true)
            }
        }

        async function testPosts() {
            if (!currentSession) {
                log('api-results', '‚ùå Please login first!', true)
                return
            }

            log('api-results', 'Testing Posts API...', false)

            try {
                // Test GET posts
                const response = await fetch(`${API_URL}/api/posts`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${currentSession.access_token}`
                    }
                })

                const data = await response.json()
                
                if (response.ok && !data.error) {
                    log('api-results', `‚úÖ Posts API working! Found ${data.posts?.length || 0} posts`, false)
                    if (data.posts?.length > 0) {
                        log('api-results', `Sample post: "${data.posts[0].content?.substring(0, 50)}..."`, false)
                    }
                } else {
                    log('api-results', `‚ùå Posts API error: ${data.error || 'Unknown error'}`, true)
                }

                // Test CREATE post
                const createResponse = await fetch(`${API_URL}/api/posts`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${currentSession.access_token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content: `Test post from Hollywood! Created at ${new Date().toLocaleTimeString()}`,
                        post_type: 'progress',
                        tags: ['test', 'demo']
                    })
                })

                const createData = await createResponse.json()
                
                if (createResponse.ok && !createData.error) {
                    log('api-results', `‚úÖ Post creation working! Created post with +5 points`, false)
                } else {
                    log('api-results', `‚ùå Post creation error: ${createData.error || 'Unknown error'}`, true)
                }

            } catch (error) {
                log('api-results', `‚ùå Posts API error: ${error.message}`, true)
            }
        }

        async function testFriends() {
            if (!currentSession) {
                log('api-results', '‚ùå Please login first!', true)
                return
            }

            log('api-results', 'Testing Friends API...', false)

            try {
                const response = await fetch(`${API_URL}/api/friends`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${currentSession.access_token}`
                    }
                })

                const data = await response.json()
                
                if (response.ok && !data.error) {
                    log('api-results', `‚úÖ Friends API working! Found ${data.friends?.length || 0} friends`, false)
                } else {
                    log('api-results', `‚ùå Friends API error: ${data.error || 'Unknown error'}`, true)
                }
            } catch (error) {
                log('api-results', `‚ùå Friends API error: ${error.message}`, true)
            }
        }

        async function testLeaderboard() {
            if (!currentSession) {
                log('api-results', '‚ùå Please login first!', true)
                return
            }

            log('api-results', 'Testing Leaderboard API...', false)

            try {
                const response = await fetch(`${API_URL}/api/leaderboard?type=friends`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${currentSession.access_token}`
                    }
                })

                const data = await response.json()
                
                if (response.ok && !data.error) {
                    log('api-results', `‚úÖ Leaderboard API working! Found ${data.leaderboard?.length || 0} entries`, false)
                } else {
                    log('api-results', `‚ùå Leaderboard API error: ${data.error || 'Unknown error'}`, true)
                }
            } catch (error) {
                log('api-results', `‚ùå Leaderboard API error: ${error.message}`, true)
            }
        }

        // Auto-fill password for faster testing
        setTimeout(() => {
            document.getElementById('password').value = 'Hollywood@1981'
        }, 1000)
    </script>
</body>
</html>