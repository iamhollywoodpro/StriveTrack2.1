<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloudflare Auth Test - StriveTrack</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-8">
    <div class="max-w-4xl mx-auto bg-white rounded-lg shadow p-6">
        <h1 class="text-3xl font-bold mb-6 text-green-600">üöÄ Cloudflare Auth + Upload Test</h1>
        <p class="text-gray-600 mb-6">Testing the new Cloudflare-native authentication system (NO SUPABASE!)</p>
        
        <div id="auth-section" class="mb-6 p-4 border rounded-lg">
            <h2 class="text-xl font-semibold mb-4">Authentication</h2>
            <div id="auth-status" class="mb-4 p-4 bg-gray-50 rounded">
                Checking authentication...
            </div>
            
            <div id="login-form" class="mb-4">
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Email:</label>
                        <input type="email" id="email" value="test@strivetrack.com" class="w-full px-3 py-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Password:</label>
                        <input type="password" id="password" value="TestPass123" class="w-full px-3 py-2 border rounded">
                    </div>
                </div>
                <div class="flex gap-4">
                    <button onclick="register()" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">Register</button>
                    <button onclick="login()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Login</button>
                    <button onclick="logout()" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">Logout</button>
                </div>
            </div>
        </div>
        
        <div id="upload-section" class="mb-6 p-4 border rounded-lg">
            <h2 class="text-xl font-semibold mb-4">Upload Test</h2>
            <div class="flex gap-4 mb-4">
                <input type="file" id="fileInput" accept="image/*,video/*" class="block">
                <button onclick="testUpload()" class="px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600">Test Upload</button>
            </div>
            <div id="upload-status" class="p-4 bg-gray-50 rounded">
                Ready for upload test...
            </div>
        </div>
        
        <div id="logs" class="border p-4 bg-black text-green-400 font-mono text-sm max-h-96 overflow-y-auto">
            <div>üöÄ Cloudflare Auth System Ready!</div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://strivetrack-media-api.iamhollywoodpro.workers.dev/api';
        let currentToken = localStorage.getItem('cf_auth_token');
        
        function log(message) {
            const logs = document.getElementById('logs');
            const time = new Date().toLocaleTimeString();
            logs.innerHTML += `<div>[${time}] ${message}</div>`;
            logs.scrollTop = logs.scrollHeight;
            console.log(message);
        }
        
        async function checkAuth() {
            const authStatus = document.getElementById('auth-status');
            
            if (!currentToken) {
                authStatus.innerHTML = '<div class="text-red-600">‚ùå Not authenticated</div>';
                log('‚ùå No auth token found');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/auth/me`, {
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    authStatus.innerHTML = `
                        <div class="text-green-600">
                            ‚úÖ Authenticated with Cloudflare!<br>
                            üë§ User: ${data.user.email}<br>
                            üÜî ID: ${data.user.id}<br>
                            üîë Token: ${currentToken.substring(0, 20)}...
                        </div>
                    `;
                    log(`‚úÖ Authenticated as: ${data.user.email}`);
                } else {
                    currentToken = null;
                    localStorage.removeItem('cf_auth_token');
                    authStatus.innerHTML = '<div class="text-red-600">‚ùå Token expired or invalid</div>';
                    log('‚ùå Token expired, please login again');
                }
            } catch (error) {
                log(`üí• Auth check error: ${error.message}`);
                authStatus.innerHTML = '<div class="text-red-600">üí• Auth check failed</div>';
            }
        }
        
        async function register() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                log('‚ö†Ô∏è Please enter email and password');
                return;
            }
            
            log(`üìù Registering: ${email}`);
            
            try {
                const response = await fetch(`${API_BASE}/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email,
                        password,
                        name: email.split('@')[0]
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    currentToken = data.token;
                    localStorage.setItem('cf_auth_token', currentToken);
                    log(`‚úÖ Registration successful! Welcome ${data.user.email}`);
                    checkAuth();
                } else {
                    log(`‚ùå Registration failed: ${data.error}`);
                }
            } catch (error) {
                log(`üí• Registration error: ${error.message}`);
            }
        }
        
        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                log('‚ö†Ô∏è Please enter email and password');
                return;
            }
            
            log(`üîê Logging in: ${email}`);
            
            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    currentToken = data.token;
                    localStorage.setItem('cf_auth_token', currentToken);
                    log(`‚úÖ Login successful! Welcome back ${data.user.email}`);
                    checkAuth();
                } else {
                    log(`‚ùå Login failed: ${data.error}`);
                }
            } catch (error) {
                log(`üí• Login error: ${error.message}`);
            }
        }
        
        async function logout() {
            log('üö™ Logging out...');
            
            try {
                if (currentToken) {
                    await fetch(`${API_BASE}/auth/logout`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${currentToken}`
                        }
                    });
                }
                
                currentToken = null;
                localStorage.removeItem('cf_auth_token');
                log('‚úÖ Logout successful');
                checkAuth();
            } catch (error) {
                log(`üí• Logout error: ${error.message}`);
            }
        }
        
        async function testUpload() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                log('‚ö†Ô∏è Please select a file first');
                return;
            }
            
            if (!currentToken) {
                log('‚ùå Please login first');
                return;
            }
            
            log(`üìÇ Uploading: ${file.name} (${file.type}, ${(file.size / 1024 / 1024).toFixed(2)} MB)`);
            
            try {
                const uploadStatus = document.getElementById('upload-status');
                uploadStatus.innerHTML = '<div class="text-blue-600">üöÄ Uploading with Cloudflare auth...</div>';
                
                const response = await fetch(`${API_BASE}/upload`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`,
                        'x-file-name': file.name,
                        'Content-Type': file.type
                    },
                    body: file
                });
                
                log(`üì• Upload response: ${response.status} ${response.statusText}`);
                
                if (response.ok) {
                    const result = await response.json();
                    log(`‚úÖ Upload successful! Key: ${result.key}`);
                    uploadStatus.innerHTML = '<div class="text-green-600">‚úÖ Upload successful with Cloudflare auth!</div>';
                    
                    // Test verification
                    log(`üîç Verifying upload...`);
                    const verifyResponse = await fetch(`${API_BASE}/media/${encodeURIComponent(result.key)}`, {
                        method: 'HEAD',
                        headers: {
                            'Authorization': `Bearer ${currentToken}`
                        }
                    });
                    
                    if (verifyResponse.ok) {
                        log(`üéâ PERFECT! Upload and verification both successful!`);
                        uploadStatus.innerHTML = '<div class="text-green-600">üéâ COMPLETE SUCCESS! Cloudflare system working perfectly!</div>';
                    } else {
                        log(`‚ö†Ô∏è Upload succeeded but verification failed: ${verifyResponse.status}`);
                    }
                    
                } else {
                    const errorText = await response.text();
                    log(`‚ùå Upload failed: ${errorText}`);
                    uploadStatus.innerHTML = `<div class="text-red-600">‚ùå Upload failed: ${errorText}</div>`;
                }
                
            } catch (error) {
                log(`üí• Upload error: ${error.message}`);
                uploadStatus.innerHTML = `<div class="text-red-600">üí• Error: ${error.message}</div>`;
            }
        }
        
        // Initialize
        window.addEventListener('load', () => {
            log('üöÄ Cloudflare Auth System Loaded - NO SUPABASE!');
            checkAuth();
        });
    </script>
</body>
</html>